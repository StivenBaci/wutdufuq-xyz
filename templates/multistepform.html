<form id="regForm" action="">
  <fieldset class="form-container-vertical">
    <!-- One "tab" for each step in the form: -->
    <div class="tab">
      <p>
        <select placeholder="Geschlecht*" name="gender" oninput="this.className = ''" required>
          <option selected hidden value="">Geschlecht wählen</option>
          <option value="männlich">männlich</option>
          <option value="weiblich">weiblich</option>
          <option value="divers">divers</option>
        </select>
      </p>
      <p><input placeholder="Vorname*" oninput="this.className = ''" required></p>
      <p><input placeholder="Nachname*" oninput="this.className = ''" required></p>
      <p><input type="email" placeholder="E-Mail-Adresse*" oninput="this.className = ''" required></p>
      <p>
        <label for="versichert?" >Sind Sie bereits bei der IKK BB versichert?*
        <input type="radio" name="versichert?" id="yes" placeholder="versichert?" value='Ja' required oninput="this.className = ''">Ja
        <input type="radio" name="versichert?" id="no" placeholder="versichert?" value='Nein' required oninput="this.className = ''">Nein
      </p>
      <p class="checkbox-container">
        <div class="container-row">
        <input type="checkbox" id="informationen" placeholder="informationen" value="">
        <label for="informationen">
            <p>
              Ich erlaube der IKK BB, meine hier hinterlegten Angaben zu nutzen, um mich über die besonderen Leistungen und Vorteile der IKK BB (z.B. Schwangerschaftsleistungen und Familienleistungen) schriftlich, telefonisch oder per E-Mail zu informieren. Dieses Einverständnis kann jederzeit widerrufen werden, schriftlich, telefonisch oder per E-Mail an service@ikkbb.de.</label>
            </p>
          </div>
        <div class="container-row">
        <input type="checkbox" id="newsletter" placeholder="newsletter" value="">
          <label for="newsletter">
            <p>
              Ich möchte den kostenlosen Newsletter der IKK BB abonnieren, mit dem ich regelmäßig über aktuelle Gesundheitshemen und besondere Angebote informiert werde. Ich bin damit einverstanden, dass meine E-Mail-Nutzung und Interaktion zum Zweck der Verbesserung des Kundenservices (sog. Einzelnutzertracking) erfasst, gespeichert und ausgewertet wird. Meine personenbezogenen Daten werden nur für den Zweck des E-Mail-Versands an unseren E-Mail-Dienstleister weitergegeben. Ich kann meine Einwilligung zum Einzelnutzertracking sowie zum Newsletterversand widerrufen. Jeder Newsletter enthält einen Abmeldelink. Alle Angaben sind freiwillig und können jederzeit widerrufen werden, schriftlich, telefonisch oder per E-Mail an <a href="mailto:marketing@ikkbb.de">marketing@ikkbb.de</a>.
            </p>
            </label>
        </div>
        <div class="container-row">
          <input placeholder='datenschutz' type="checkbox" id="datenschutz" value=true required oninput="this.className = ''">
          <label for="datenschutz">
            <p>
              Mit Absenden des Formulars bestätige ich, dass ich die <a href="https://www.ikkbb.de/datenschutz" target="_blank">Datenschutzerklärung</a> gelesen habe und mit der Verarbeitung meiner Daten einverstanden bin.
            </p>
            </label>
        </div>
      </p>
    </div>

    <div class="tab">
      <p><input placeholder="Straße, Hausnummer*" oninput="this.className = ''" required></p>
      <div class="plz-ort-row">
        <input class="PLZ" style="width:35%" placeholder="Postleitzahl*" oninput="this.className = ''" required>
        <input class="ORT" style="width:55%" placeholder="Ort*" oninput="this.className = ''" required>
      </div>
      <p>
        <label for="Errechneter Geburtstermin" title>Errechneter Geburtstermin</label>
        <input placeholder="Errechneter Geburtstermin" name="Errechneter Geburtstermin" oninput="this.className = ''" type="date">
      </p>
      <p><input placeholder="Telefonnummer" oninput="this.className = ''"></p>
    </div>

    <div style="overflow:auto;">
      <div style="float:right;">
        <button type="button" id="submitBtn" onclick="nextPrev(1)">BESTELLEN</button>
      </div>
    </div>

    <!-- Circles which indicates the steps of the form: -->
    <div style="text-align:center;margin-top:40px;display:none;">
      <span class="step"></span>
      <span class="step"></span>
    </div>
  </fieldset>
</form>

<style>
  /* Style the form */
  #regForm {
    background-color: #ffffff;
    /* margin: 100px auto; */
    padding: 40px;
    width: 70%;
    min-width: 300px;
    margin-top: 0em;
  }
  
  #regform a {
    color: #e58998!important;
  }

  .form-container-vertical h2 {
    color: #006eb7;
    font-family: "Proxima Nova Extra Bold", sans-serif, Helvetica, Arial;
    font-size: 1rem;
    font-weight: 300;
    letter-spacing: -.0275rem;
    line-height: 1.25;
    margin: 0 0 .3125rem 0;
    padding: 0;
    text-align: left;
  }

  .form-container-vertical p {
    font-family: "Proxima Nova Regular", sans-serif, Helvetica, Arial;
    color: #1d1d1b;
    font-weight: 300;
  }
  
  fieldset legend {
      border-bottom: none;
      margin: 1.25rem 0;
      color: #acacac;
  }

  legend {
      display: block;
      width: 100%;
      max-width: 100%;
      padding: 0;
      margin-bottom: 0.5rem;
      font-size: 1.5rem;
      line-height: inherit;
      white-space: normal;
  }

  button:hover, button:active {
      background-color: #575757;
      color: #ffffff;
  }

  button, button:visited {
      cursor: pointer;
      background-color: #e58998;
      color: #ffffff;
      font-size: 0.625rem;
      font-weight: 600;
      height: 45px;
      min-width: 225px;
      margin: 0 auto;
      margin-bottom: 10px;
      margin-right: 10px;
      padding-left: 18px;
      padding-right: 18px;
      align-items: center;
      display: inline-flex;
      justify-content: center;
      font-family: "Proxima Nova Semi Bold", sans-serif, Helvetica, Arial;
      font-size: 1rem;
      font-weight: 500;
      letter-spacing: .1875rem;
      line-height: 1;
      padding: .625rem 1.75rem;
      text-align: center;
      text-transform: uppercase;
      transition: background-color .3s,border-color .3s;
      user-select: none;
      vertical-align: middle;
      border: none;
  }

  /* Style the input fields */

  select {
    padding: 10px;
    width: 100%;
    font-size: 17px;
    font-family: "Proxima Nova", sans-serif, Helvetica, Arial;
    border: 1px solid #aaaaaa;
  }

  select.invalid {
    background-color: #EBCCD1;
  }

  input {
    padding: 10px;
    width: 100%;
    font-size: 17px;
    font-family: "Proxima Nova", sans-serif, Helvetica, Arial;
    border: 1px solid #aaaaaa;
  }

  /* Mark input boxes that gets an error on validation: */
  input.invalid {
    appearance: none;
    border: 1px solid;
    background-color: #EBCCD1;
    color: #A94442;
  }

  input[type=submit] {
      background-color: #FFC0CB;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
  }

  .plz-ort-row {
    display: flex;
  }

  label {
    display: inline-flex;
    align-items: center;
    font-size: 18px;
  }

  label p {
    margin-top: 0;

  }

  input[type="radio"] {
    margin-right: 10px;
    width: 20px;
  }

  .checkbox-container {
    display: flex;
    flex-direction: column;
    margin-bottom: 10px;
  }

  .container-row {
      display: flex;
  }

  .checkbox-container input {
    margin-right: 10px;
  }

  input[type="checkbox"] {
    height: 15px;
    width: 15px;
    cursor: pointer;
    box-sizing: border-box;
    padding: 0;
    margin-right: 0.9375rem;
  }

  input[type="checkbox"]:checked {
    background-color: #04AA6D;
  }

  /* Hide all steps by default: */
  .tab {
    display: none;
  }

  /* Make circles that indicate the steps of the form: */
  .step {
    height: 15px;
    width: 15px;
    margin: 0 2px;
    background-color: #bbbbbb;
    border: none;
    border-radius: 50%;
    display: inline-block;
    opacity: 0.5;
  }

  /* Mark the active step: */
  .step.active {
    opacity: 1;
  }

  /* Mark the steps that are finished and valid: */
  .step.finish {
    background-color: #04AA6D;
  }
</style>


<script>
var currentTab = 0; // Current tab is the first tab (0)
var submitCount = 0;
showTab(currentTab); // Display current tab    



function displaySuccessMessage() {
  document.querySelector(".form-container-vertical").innerHTML = `
  <h2>Fast geschafft: Bitte bestätigen Sie Ihre E-Mail-Adresse</h2>
    <p>
    </br></br>
    Nur noch ein Schritt zu Ihrem Schwangerschaftstagebuch: Wir haben Ihnen eine E-Mail geschickt – bitte klicken Sie dort auf den Bestätigungslink und freuen sich auf Post von uns.
    </br></br>
    Sollten Sie keine E-Mail erhalten, schauen Sie bitte in Ihrem Spam-Ordner nach. Möglichweise kann es auch eine Verzögerung der E-Mail-Zustellung geben.
    </p>`;
}    

function showTab(n) {
  // This function will display the specified tab of the form
  var x = document.getElementsByClassName("tab");
  x[n].style.display = "block";
  // fix the Previous/Next buttons:
  if (n == 0) {
    document.getElementById("submitBtn").innerHTML = "WEITER";
  } else {
    document.getElementById("submitBtn").innerHTML = "BESTELLEN";
    document.getElementById("prevBtn").style.display = "inline";
  }
  // if (n == (x.length - 1)) {
  //   document.getElementById("nextBtn").remove();
  // } else {
  //   document.getElementById("nextBtn").innerHTML = "Next";
  // }
  fixStepIndicator(n)
}

function nextPrev(n) {
    // This function will figure out which tab to display
    var x = document.getElementsByClassName("tab");
    // Exit the function if any field in the current tab is invalid:
    if (n == 1 && !validateForm()) return false;
    if (n == 1 && validateForm()) submitForm();
    // Hide the current tab:
    x[currentTab].style.display = "none";
    // Increase the current tab by 1:
    currentTab = currentTab + n;
    // IF in case you have reached the end of the form... :
    if (currentTab >= x.length) {
      //...the form ends and it's replaced with success message
      displaySuccessMessage();
      return false; // stop function from showing the tab again
    }
    // Otherwise, display the correct tab:
    showTab(currentTab);
  }

function validateForm() {
  // This function deals with validation of the form fields
  var x, y, i, valid = true;
  x = document.getElementsByClassName("tab");
  y = x[currentTab].querySelectorAll("[required]");

  for (i = 0; i < y.length; i++) {
    if (y[i].value == "" && !y[i].reportValidity()) {
      y[i].className += " invalid";
      valid = false;
    }
  }

  if (!document.getElementById("yes").checked && !document.getElementById("no").checked ) {
    document.getElementById("yes").reportValidity();
    document.getElementById("no").reportValidity();
    return false; // Prevents form submission
  }

  if (!document.getElementById("datenschutz").checked ) {
    document.getElementById("datenschutz").reportValidity();
    return false; // Prevents form submission
  }

  // If the valid status is true, mark the step as finished and valid:
  if (valid) {
    document.getElementsByClassName("step")[currentTab].className += " finish";
  }
  return valid; // return the valid status
}

function fixStepIndicator(n) {
  // This function removes the "active" class of all steps...
  var i, x = document.getElementsByClassName("step");
  for (i = 0; i < x.length; i++) {
    x[i].className = x[i].className.replace(" active", "");
  }
  //... and adds the "active" class to the current step:
  x[n].className += " active";
}

function submitForm() {
  const formData = {};

  const tabs = document.getElementsByClassName("tab");

  // Iterate through each tab and collect input values
  for (let i = 0; i < tabs.length; i++) {
    const inputs = tabs[i].querySelectorAll("input, select");

    // Iterate through each input and create a key-value pair in formData
    for (let j = 0; j < inputs.length; j++) {
      const inputName = inputs[j].getAttribute("placeholder");


      // Ensure `inputName` is valid before using it
      if (!inputName) {
        continue; // Skip inputs without placeholders
      }
      formData[inputName] = inputs[j].value;
    }
  }

  // Validation
  if (!validateForm() ) {
    console.log('Validation failed.');
    return false; // Prevents form submission
  }

  // formData and input values are validated
  
  
  // API Request to Lambda Function
  console.log("Submitting form data:", formData); 
  // Convert the formData object to JSON and format for Maileon

  userEmail = formData["E-Mail-Adresse*"]

  maileonData = {
    "custom_fields": {
                      "Ikkbbmember": Array.from(document.querySelectorAll('[required]'))
                                          .filter(radio => radio.checked)[0].value,
                      "Interesse_vorhanden": (document.getElementById('informationen').checked ? 'true' : ''),
                      "Newsletter_Anmeldung": (document.getElementById('newsletter').checked ? 'true' : ''),
                      "Telefonnummer": formData['Telefonnummer'],
                      "Datenschutz": formData['datenschutz'],
                      "Geburtstermin": formData['Errechneter Geburtstermin']
                      },
    "standard_fields": {
                        "userEmail": formData["E-Mail-Adresse*"],
                        "FIRSTNAME": formData["Vorname*"],
                        "LASTNAME": formData["Nachname*"],
                        "Straße": formData['Straße, Hausnummer*'],
                        "Ort": formData['Ort*'],
                        "PLZ": formData['Postleitzahl*'],
                        "Geschlecht": formData["Geschlecht*"]
                      } 
  };
  console.log(maileonData);
  //(TO-DO: Ideally send the data straight to Maileon, requires a safe environment for the api key.)

  const url = 'https://5zi6p73htunuaydxfs3jlgs74y0avmxs.lambda-url.eu-central-1.on.aws/'
  fetch(url, {
    method: 'POST',
    body: JSON.stringify(maileonData),
  })
    .then(response => response.json())
    .then(data => console.log(data))
    .catch(error => console.error(error));
}

submitCount += 1;  

if (submitCount >= 2) {
  //form ends and it's replaced with success message
  displaySuccessMessage();
}
</script>
